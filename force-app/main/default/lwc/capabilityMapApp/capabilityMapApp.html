<template>
    <div class="app-container">
        <!-- HEADER - Matching mockup design -->
        <header class="app-header">
            <div class="logo">
                <svg viewBox="0 0 32 32" fill="none">
                    <rect x="2" y="2" width="12" height="12" rx="2" fill="#1B96FF"/>
                    <rect x="18" y="2" width="12" height="12" rx="2" fill="#1B96FF" opacity="0.7"/>
                    <rect x="2" y="18" width="12" height="12" rx="2" fill="#1B96FF" opacity="0.7"/>
                    <rect x="18" y="18" width="12" height="12" rx="2" fill="#1B96FF" opacity="0.4"/>
                </svg>
                <span>Capability Map</span>
            </div>
            
            <div class="title-group">
                <template if:true={hasMap}>
                    <input type="text" class="title-input" value={mapName} onchange={handleMapNameChange}>
                    <span class={statusBadgeClass}>{statusText}</span>
                </template>
                <template if:false={hasMap}>
                    <span class="title-placeholder">Select or create a Capability Map</span>
                </template>
            </div>
            
            <div class="toolbar">
                <button class="btn icon" title="Undo" disabled={cannotUndo} onclick={handleUndo}>‚Ü∂</button>
                <button class="btn icon" title="Redo" disabled={cannotRedo} onclick={handleRedo}>‚Ü∑</button>
                <div class="divider"></div>
                <button class="btn orange" onclick={handleOpenTemplates}>
                    <span>‚òÅÔ∏è</span> Salesforce Templates
                </button>
                <div class="divider"></div>
                <button class="btn" onclick={handleExport}>Export</button>
                <button class="btn" onclick={handleImport}>Import</button>
                <button class="btn primary" onclick={handleAddCapability}>+ Add Capability</button>
            </div>
        </header>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <!-- SIDEBAR -->
            <aside class="sidebar">
                <!-- FILTERS - Standalone section at top -->
                <div class="sidebar-section filters-section">
                    <div class="section-title">Filters</div>
                    <div class="search-box">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="M21 21l-4.35-4.35"/>
                        </svg>
                        <input type="text" placeholder="Search capabilities..." value={searchTerm} onkeyup={handleSearchChange}>
                    </div>
                    
                    <!-- Phase Filter -->
                    <div class="filter-group">
                        <div class="filter-label">Phase</div>
                        <div class="filter-chips">
                            <template for:each={phaseFilterOptions} for:item="phase">
                                <button key={phase.value} 
                                        class={phase.chipClass} 
                                        data-value={phase.value}
                                        onclick={handlePhaseFilterClick}>
                                    {phase.label}
                                </button>
                            </template>
                        </div>
                    </div>
                    
                    <!-- Size Filter -->
                    <div class="filter-group">
                        <div class="filter-label">Size</div>
                        <div class="filter-chips">
                            <template for:each={sizeFilterOptions} for:item="size">
                                <button key={size.value} 
                                        class={size.chipClass} 
                                        data-value={size.value}
                                        onclick={handleSizeFilterClick}>
                                    {size.label}
                                </button>
                            </template>
                        </div>
                    </div>
                    
                    <!-- Clear Filters -->
                    <template if:true={hasActiveFilters}>
                        <button class="clear-filters-btn" onclick={handleClearFilters}>
                            ‚úï Clear Filters
                        </button>
                    </template>
                </div>
                
                <div class="sidebar-content">
                    <!-- Projects Section (Recent + New Map combined, collapsible) -->
                    <div class="sidebar-section projects-section">
                        <div class="section-title collapsible" onclick={toggleProjectsSection}>
                            <span>{projectsSectionIcon} Projects</span>
                            <template if:true={hasFavorites}>
                                <span class="section-count">{myFavorites.length}</span>
                            </template>
                        </div>
                        <template if:true={projectsSectionExpanded}>
                            <div class="projects-content">
                                <!-- New Map -->
                                <div class="new-map-area">
                                    <c-project-selector onprojectselected={handleProjectSelected}></c-project-selector>
                                </div>
                                
                                <!-- Recent Projects List -->
                                <template if:true={hasFavorites}>
                                    <div class="recent-label">Recent</div>
                                    <div class="favorites-list">
                                        <template for:each={myFavorites} for:item="fav">
                                            <div key={fav.id} class="favorite-item" data-id={fav.id} onclick={handleFavoriteClick}>
                                                <span class={fav.starClass} data-id={fav.id} onclick={handleToggleFavorite} title="Toggle favorite">{fav.starIcon}</span>
                                                <span class="favorite-name">{fav.name}</span>
                                                <span class="favorite-time">{fav.lastAccessedFormatted}</span>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                    
                    <!-- Selection Actions (when items selected) -->
                    <template if:true={hasSelection}>
                        <div class="sidebar-section">
                            <div class="section-title">{selectedCount} Selected</div>
                            <div class="action-buttons">
                                <button class="action-btn" onclick={handleBulkChangeSize}>
                                    <span class="action-icon">üìê</span> Change Size
                                </button>
                                <template if:true={selectedHaveSizes}>
                                    <button class="action-btn secondary" onclick={handleResetSize}>
                                        <span class="action-icon">‚Ü©Ô∏è</span> Reset Size
                                    </button>
                                </template>
                                <button class="action-btn" onclick={handleBulkChangePhase}>
                                    <span class="action-icon">üìÖ</span> Change Phase
                                </button>
                                <template if:true={selectedHavePhases}>
                                    <button class="action-btn secondary" onclick={handleResetPhase}>
                                        <span class="action-icon">‚Ü©Ô∏è</span> Reset Phase
                                    </button>
                                </template>
                                <button class="action-btn" onclick={handleBulkAssignTeam}>
                                    <span class="action-icon">üë•</span> Assign Team
                                </button>
                                <button class="action-btn danger" onclick={handleBulkDelete}>
                                    <span class="action-icon">üóëÔ∏è</span> Delete
                                </button>
                                <button class="action-btn secondary" onclick={handleClearSelection}>
                                    <span class="action-icon">‚úï</span> Clear Selection
                                </button>
                            </div>
                        </div>
                    </template>
                    
                    <!-- Colors & Phases Section -->
                    <div class="sidebar-section">
                        <div class="section-title">Colors & Phases</div>
                        <template for:each={colorBreakdown} for:item="colorGroup">
                            <div key={colorGroup.color} class="color-group">
                                <div class="color-group-header" data-color={colorGroup.color} onclick={toggleColorGroup}>
                                    <div class="color-indicator" style={colorGroup.colorStyle}></div>
                                    <span class="color-name">{colorGroup.name}</span>
                                    <template if:true={colorGroup.hasPhase}>
                                        <span class="phase-label">{colorGroup.phaseLabel}</span>
                                    </template>
                                    <span class="color-total">{colorGroup.total}</span>
                                    <span class="expand-icon">{colorGroup.expandIcon}</span>
                                </div>
                                <template if:true={colorGroup.isExpanded}>
                                    <div class="size-breakdown">
                                        <template for:each={colorGroup.sizes} for:item="sizeItem">
                                            <div key={sizeItem.size} class="size-row">
                                                <span class="size-badge" style={sizeItem.badgeStyle}>{sizeItem.size}</span>
                                                <span class="size-label">{sizeItem.label}</span>
                                                <span class="size-count">{sizeItem.count}</span>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </template>
                        <template if:false={hasColoredCapabilities}>
                            <div class="empty-state">
                                <p>No colors assigned yet</p>
                                <p class="empty-hint">Select capabilities and click a color to assign</p>
                            </div>
                        </template>
                    </div>
                </div>
                
                <div class="sidebar-footer">
                    <div class="stats-row"><span>Categories</span><span>{categoryCount}</span></div>
                    <div class="stats-row"><span>Capabilities</span><span>{capabilityCount}</span></div>
                    <div class="stats-row"><span>Total Hours</span><span>{totalHours}</span></div>
                </div>
            </aside>

            <!-- CANVAS AREA -->
            <main class="canvas-area">
                <!-- Canvas Toolbar -->
                <div class="canvas-toolbar">
                    <div class="tool-group">
                        <label class="select-all-label" title="Select/deselect all capabilities">
                            <input type="checkbox" checked={allSelected} onchange={handleSelectAllChange}>
                            <span>Select All</span>
                        </label>
                        <button class={allFilterClass} onclick={handleFilterAll}>All</button>
                        <button class={sizedFilterClass} onclick={handleFilterSized}>Sized</button>
                        <button class={tbdFilterClass} onclick={handleFilterTbd}>TBD Only</button>
                    </div>
                    
                    <!-- Color Palette in Toolbar -->
                    <div class="toolbar-colors">
                        <template for:each={colorOptions} for:item="color">
                            <div key={color.id} 
                                 class={color.squareClass}
                                 style={color.style}
                                 data-color={color.hex}
                                 onclick={handleColorSelect}
                                 title={color.name}>
                            </div>
                        </template>
                        <label class="apply-all-label" title="Override phase-color lock and apply to all capabilities">
                            <input type="checkbox" checked={applyColorToAll} onchange={handleApplyAllChange}>
                            <span>All phases</span>
                        </label>
                        <template if:true={hasUnsavedChanges}>
                            <button class="save-colors-btn" onclick={handleSaveColors}>Save</button>
                        </template>
                        <template if:true={hasColoredCapabilities}>
                            <button class="reset-btn" onclick={handleResetAllColors} title="Clear all colors">Reset</button>
                        </template>
                    </div>
                    
                    <div class="zoom-group">
                        <button class="zoom-btn" onclick={handleZoomOut}>‚àí</button>
                        <span class="zoom-level">{zoomLevelText}</span>
                        <button class="zoom-btn" onclick={handleZoomIn}>+</button>
                    </div>
                </div>
                
                <!-- Map Container -->
                <div class="map-container">
                    <div class="capability-map" style={mapTransformStyle}>
                        <template for:each={categoriesWithCapabilities} for:item="category">
                            <div key={category.Id} class="category-column" data-category-id={category.Id}
                                 ondragover={handleDragOver} ondrop={handleDrop}>
                                <div class={category.headerClass}>
                                    <span>{category.Name}</span>
                                    <span class="grip">‚ãÆ‚ãÆ</span>
                                </div>
                                
                                <template for:each={category.capabilities} for:item="cap">
                                    <div key={cap.Id} 
                                         class={cap.tileClass}
                                         style={cap.tileStyle}
                                         data-size={cap.Size__c}
                                         data-id={cap.Id}
                                         draggable="true"
                                         onclick={handleTileClick}
                                         ondblclick={handleTileDoubleClick}
                                         oncontextmenu={handleTileContextMenu}
                                         ondragstart={handleDragStart}
                                         ondragend={handleDragEnd}>
                                        <div class="tile-content">
                                            <span class="tile-name">{cap.Name}</span>
                                            <div class="tile-meta">
                                                <span class="tile-size">{cap.Size__c}</span>
                                                <span class="tile-phase">{cap.displayPhase}</span>
                                                <span class="tile-hours">{cap.displayHours}h</span>
                                            </div>
                                        </div>
                                        <span class="grip">‚ãÆ‚ãÆ</span>
                                    </div>
                                </template>
                                
                                <div class="add-tile" data-category-id={category.Id} onclick={handleAddCapabilityToCategory}>
                                    <span class="add-icon">+</span>
                                    <span>Add</span>
                                </div>
                            </div>
                        </template>
                        
                        <!-- Add Category Column -->
                        <div class="add-category-column" onclick={handleAddCategory}>
                            <span class="add-icon">+</span>
                            <span>Add Category</span>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- STATUS BAR -->
        <footer class="status-bar">
            <div class="status-item">
                <span class="status-dot"></span>
                <span>{connectionStatus}</span>
            </div>
            <div class="status-item">
                <span>{capabilityCount}</span> capabilities
            </div>
            <div class="status-item">
                Click = select ‚Ä¢ Ctrl+Click = multi-select ‚Ä¢ Double-click = edit
            </div>
        </footer>

        <!-- MODALS -->
        <template if:true={showCapabilityModal}>
            <c-capability-edit-modal 
                capability={selectedCapability}
                category-id={selectedCategoryId}
                map-id={mapId}
                categories={categories}
                mode={modalMode}
                onclose={handleCloseCapabilityModal}
                onsaved={handleCapabilitySaved}>
            </c-capability-edit-modal>
        </template>

        <template if:true={showCategoryModal}>
            <c-category-edit-modal 
                category={selectedCategory}
                map-id={mapId}
                mode={modalMode}
                onclose={handleCloseCategoryModal}
                onsaved={handleCategorySaved}>
            </c-category-edit-modal>
        </template>

        <template if:true={showTemplateModal}>
            <c-capability-map-template-modal 
                map-id={mapId}
                applied-templates={appliedTemplates}
                onclose={handleCloseTemplateModal}
                ontemplatesapplied={handleTemplatesApplied}>
            </c-capability-map-template-modal>
        </template>

        <template if:true={showBulkSizeModal}>
            <c-bulk-operations-modal 
                selected-capability-ids={selectedCapabilityIds}
                operation-type="size"
                onclose={handleCloseBulkModal}
                onapplied={handleBulkApplied}>
            </c-bulk-operations-modal>
        </template>

        <template if:true={showBulkPhaseModal}>
            <c-bulk-operations-modal 
                selected-capability-ids={selectedCapabilityIds}
                operation-type="phase"
                onclose={handleCloseBulkPhaseModal}
                onapplied={handleBulkPhaseApplied}>
            </c-bulk-operations-modal>
        </template>

        <template if:true={showBulkTeamModal}>
            <c-bulk-operations-modal 
                selected-capability-ids={selectedCapabilityIds}
                operation-type="team"
                map-id={mapId}
                onclose={handleCloseBulkTeamModal}
                onapplied={handleBulkTeamApplied}>
            </c-bulk-operations-modal>
        </template>

        <!-- Context Menu -->
        <template if:true={showContextMenu}>
            <div class="context-menu" style={contextMenuStyle}>
                <div class="context-menu-item" onclick={handleContextEdit}>‚úèÔ∏è Edit</div>
                <div class="context-menu-item" onclick={handleContextDuplicate}>üìã Duplicate</div>
                <div class="context-menu-divider"></div>
                <div class="context-menu-item" onclick={handleContextChangeSize}>üé® Change Size</div>
                <div class="context-menu-divider"></div>
                <div class="context-menu-item danger" onclick={handleContextDelete}>üóëÔ∏è Delete</div>
            </div>
        </template>

        <!-- Toast -->
        <template if:true={showToast}>
            <div class="toast-container">
                <div class={toastClass}>{toastMessage}</div>
            </div>
        </template>
    </div>
</template>