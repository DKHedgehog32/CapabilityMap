<template>
    <div class="app-container">
        <!-- HEADER - Matching mockup design -->
        <header class="app-header">
            <div class="logo">
                <svg viewBox="0 0 32 32" fill="none">
                    <rect x="2" y="2" width="12" height="12" rx="2" fill="#1B96FF"/>
                    <rect x="18" y="2" width="12" height="12" rx="2" fill="#1B96FF" opacity="0.7"/>
                    <rect x="2" y="18" width="12" height="12" rx="2" fill="#1B96FF" opacity="0.7"/>
                    <rect x="18" y="18" width="12" height="12" rx="2" fill="#1B96FF" opacity="0.4"/>
                </svg>
                <span>Capability Map</span>
            </div>
            
            <div class="title-group">
                <template if:true={hasMap}>
                    <input type="text" class="title-input" value={mapName} onchange={handleMapNameChange}>
                    <span class={statusBadgeClass}>{statusText}</span>
                </template>
                <template if:false={hasMap}>
                    <c-project-selector onprojectselected={handleProjectSelected}></c-project-selector>
                </template>
            </div>
            
            <div class="toolbar">
                <button class="btn icon" title="Undo" disabled={cannotUndo} onclick={handleUndo}>‚Ü∂</button>
                <button class="btn icon" title="Redo" disabled={cannotRedo} onclick={handleRedo}>‚Ü∑</button>
                <div class="divider"></div>
                <button class="btn orange" onclick={handleOpenTemplates}>
                    <span>‚òÅÔ∏è</span> Salesforce Templates
                </button>
                <div class="divider"></div>
                <button class="btn" onclick={handleExport}>Export</button>
                <button class="btn" onclick={handleImport}>Import</button>
                <button class="btn primary" onclick={handleAddCapability}>+ Add Capability</button>
            </div>
        </header>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <!-- SIDEBAR -->
            <aside class="sidebar">
                <div class="sidebar-header">
                    <div class="sidebar-title">
                        <span>Categories</span>
                        <button onclick={handleAddCategory}>+</button>
                    </div>
                    <div class="search-box">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="M21 21l-4.35-4.35"/>
                        </svg>
                        <input type="text" placeholder="Search..." value={searchTerm} onkeyup={handleSearchChange}>
                    </div>
                </div>
                
                <div class="sidebar-content">
                    <!-- Category List -->
                    <div class="category-list">
                        <template for:each={categoriesWithCount} for:item="cat">
                            <div key={cat.Id} class={cat.itemClass} data-id={cat.Id} onclick={handleCategoryClick}>
                                <span class="cat-name">{cat.Name}</span>
                                <span class="cat-count">{cat.capabilityCount}</span>
                                <div class="cat-actions">
                                    <button data-id={cat.Id} onclick={handleEditCategory}>‚úèÔ∏è</button>
                                    <button class="delete" data-id={cat.Id} onclick={handleDeleteCategory}>üóëÔ∏è</button>
                                </div>
                            </div>
                        </template>
                    </div>
                    
                    <!-- Size Legend -->
                    <div class="sidebar-title"><span>Sizing</span></div>
                    <div class="size-legend">
                        <template for:each={sizeLegendItems} for:item="size">
                            <div key={size.id} class={size.itemClass} data-size={size.id} onclick={handleSizeFilterToggle}>
                                <div class="size-color" style={size.colorStyle}>{size.label}</div>
                                <div class="size-info">{size.description}</div>
                                <span class="size-count">{size.count}</span>
                            </div>
                        </template>
                    </div>
                </div>
                
                <div class="sidebar-footer">
                    <div class="stats-row"><span>Categories</span><span>{categoryCount}</span></div>
                    <div class="stats-row"><span>Capabilities</span><span>{capabilityCount}</span></div>
                    <div class="stats-row"><span>Selected</span><span>{selectedCount}</span></div>
                    <div class="stats-row"><span>Total Hours</span><span>{totalHours}</span></div>
                </div>
            </aside>

            <!-- CANVAS AREA -->
            <main class="canvas-area">
                <!-- Canvas Toolbar -->
                <div class="canvas-toolbar">
                    <div class="tool-group">
                        <button class={allFilterClass} onclick={handleFilterAll}>All</button>
                        <button class={sizedFilterClass} onclick={handleFilterSized}>Sized</button>
                        <button class={tbdFilterClass} onclick={handleFilterTbd}>TBD Only</button>
                    </div>
                    
                    <template if:true={hasSelection}>
                        <div class="selection-info">
                            <span><strong>{selectedCount}</strong> selected</span>
                            <div class="selection-actions">
                                <button onclick={handleBulkChangeSize}>Change Size</button>
                                <button class="danger" onclick={handleBulkDelete}>Delete</button>
                            </div>
                        </div>
                    </template>
                    
                    <div class="zoom-group">
                        <button class="zoom-btn" onclick={handleZoomOut}>‚àí</button>
                        <span class="zoom-level">{zoomLevelText}</span>
                        <button class="zoom-btn" onclick={handleZoomIn}>+</button>
                    </div>
                </div>
                
                <!-- Map Container -->
                <div class="map-container">
                    <div class="capability-map" style={mapTransformStyle}>
                        <template for:each={categoriesWithCapabilities} for:item="category">
                            <div key={category.Id} class="category-column" data-category-id={category.Id}
                                 ondragover={handleDragOver} ondrop={handleDrop}>
                                <div class={category.headerClass}>
                                    <span>{category.Name}</span>
                                    <span class="grip">‚ãÆ‚ãÆ</span>
                                </div>
                                
                                <template for:each={category.capabilities} for:item="cap">
                                    <div key={cap.Id} 
                                         class={cap.tileClass}
                                         data-size={cap.Size__c}
                                         data-id={cap.Id}
                                         draggable="true"
                                         onclick={handleTileClick}
                                         ondblclick={handleTileDoubleClick}
                                         oncontextmenu={handleTileContextMenu}
                                         ondragstart={handleDragStart}
                                         ondragend={handleDragEnd}>
                                        <div class="checkbox" data-id={cap.Id} onclick={handleCheckboxClick}>
                                            <template if:true={cap.isSelected}>‚úì</template>
                                        </div>
                                        <span class="tile-name">{cap.Name}</span>
                                        <span class="tile-hours">{cap.displayHours}h</span>
                                        <span class="grip">‚ãÆ‚ãÆ</span>
                                    </div>
                                </template>
                                
                                <div class="add-tile" data-category-id={category.Id} onclick={handleAddCapabilityToCategory}>
                                    <span class="add-icon">+</span>
                                    <span>Add</span>
                                </div>
                            </div>
                        </template>
                        
                        <!-- Add Category Column -->
                        <div class="add-category-column" onclick={handleAddCategory}>
                            <span class="add-icon">+</span>
                            <span>Add Category</span>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- STATUS BAR -->
        <footer class="status-bar">
            <div class="status-item">
                <span class="status-dot"></span>
                <span>{connectionStatus}</span>
            </div>
            <div class="status-item">
                <span>{capabilityCount}</span> capabilities
            </div>
            <div class="status-item">
                Click = select ‚Ä¢ Ctrl+Click = multi-select ‚Ä¢ Double-click = edit
            </div>
        </footer>

        <!-- MODALS -->
        <template if:true={showCapabilityModal}>
            <c-capability-edit-modal 
                capability={selectedCapability}
                category-id={selectedCategoryId}
                map-id={mapId}
                categories={categories}
                mode={modalMode}
                onclose={handleCloseCapabilityModal}
                onsaved={handleCapabilitySaved}>
            </c-capability-edit-modal>
        </template>

        <template if:true={showCategoryModal}>
            <c-category-edit-modal 
                category={selectedCategory}
                map-id={mapId}
                mode={modalMode}
                onclose={handleCloseCategoryModal}
                onsaved={handleCategorySaved}>
            </c-category-edit-modal>
        </template>

        <template if:true={showTemplateModal}>
            <c-capability-map-template-modal 
                map-id={mapId}
                applied-templates={appliedTemplates}
                onclose={handleCloseTemplateModal}
                ontemplatesapplied={handleTemplatesApplied}>
            </c-capability-map-template-modal>
        </template>

        <template if:true={showBulkSizeModal}>
            <c-bulk-operations-modal 
                selected-capability-ids={selectedCapabilityIds}
                onclose={handleCloseBulkModal}
                onapplied={handleBulkApplied}>
            </c-bulk-operations-modal>
        </template>

        <!-- Context Menu -->
        <template if:true={showContextMenu}>
            <div class="context-menu" style={contextMenuStyle}>
                <div class="context-menu-item" onclick={handleContextEdit}>‚úèÔ∏è Edit</div>
                <div class="context-menu-item" onclick={handleContextDuplicate}>üìã Duplicate</div>
                <div class="context-menu-divider"></div>
                <div class="context-menu-item" onclick={handleContextChangeSize}>üé® Change Size</div>
                <div class="context-menu-divider"></div>
                <div class="context-menu-item danger" onclick={handleContextDelete}>üóëÔ∏è Delete</div>
            </div>
        </template>

        <!-- Toast -->
        <template if:true={showToast}>
            <div class="toast-container">
                <div class={toastClass}>{toastMessage}</div>
            </div>
        </template>
    </div>
</template>